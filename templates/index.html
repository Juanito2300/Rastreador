<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Rastreador GPS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f1f1f1}
    #map{height:100vh;width:100%}
    /* Modales */
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);
           display:none;align-items:center;justify-content:center}
    .modal:target{display:flex}
    .modal-content{background:#fff;padding:30px;border-radius:10px;width:90%;max-width:400px}
    .modal-content input{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:5px}
    .modal-content button{width:100%;padding:10px;background:#2196F3;color:#fff;border:none;border-radius:5px;cursor:pointer}
    .modal-content button:hover{background:#0b7dda}
    .link{text-align:center;margin-top:10px}.link a{color:#2196F3;text-decoration:none}
    .hidden{display:none}
    /* Bot√≥n flotante centrar */
    #centrarBtn{position:fixed;bottom:20px;right:20px;z-index:1000;padding:12px 16px;background:#2196F3;color:#fff;
                border:none;border-radius:50%;font-size:18px;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.3);display:none}
    /* Caja de b√∫squeda */
    #searchBox{position:fixed;top:20px;right:20px;z-index:1000; gap:6px;align-items:center}
    #searchBox input{padding:8px 12px;border:1px solid #ccc;border-radius:5px;font-size:14px}
    #searchBox button{padding:8px 12px;background:#4CAF50;color:#fff;border:none;border-radius:5px;cursor:pointer}
    #searchBox button:hover{background:#3c9b42}
</style>
</head>
<body>

<!-- Modal Login con dise√±o avanzado -->
<div id="login" class="modal">
  <div class="modal-content login-advanced">
    <div class="icono-satelite">üì°</div>
    <h2>Acceso al Rastreador</h2>
    <p class="subtitulo">Ingresa tu ID de rastreo satelital</p>
    <input id="inputIdLogin" placeholder="ID de 8 d√≠gitos" maxlength="8">
    <button onclick="iniciarSesion()">üîì Ingresar</button>
    <div class="link"><a href="#registro">¬øNo tienes cuenta? Reg√≠strate</a></div>
  </div>
</div>

<!-- Modal Registro -->
<div id="registro" class="modal">
  <div class="modal-content">
    <h2>Registrarse</h2>
    <input id="inputId" placeholder="ID de 8 d√≠gitos" maxlength="8">
    <input id="inputNombre" placeholder="Nombre completo">
    <input id="inputCorreo" type="email" placeholder="Correo electr√≥nico">
    <input id="inputTelefono" placeholder="Tel√©fono">
    <button onclick="registrar()">Registrar</button>
    <div class="link"><a href="#login">¬øYa tienes cuenta? Inicia sesi√≥n</a></div>
  </div>
</div>

<!-- Mapa -->
<div id="map" class="hidden"></div>

<!-- Bot√≥n centrar -->
<button id="centrarBtn" onclick="centrarEnMiUbicacion()">üìç</button>

<!-- Caja b√∫squeda -->
<div id="searchBox" class="hidden" style="position:fixed;top:20px;right:20px;z-index:1000;gap:6px;align-items:center;">
  <input id="searchId" placeholder="ID a buscar‚Ä¶" maxlength="8">
  <button onclick="buscarOtro()">Ver</button>
</div>

<!-- Emparejar pareja -->
<div id="linkBox" class="hidden" style="position:fixed;top:70px;right:20px;z-index:1000; flex-direction:column;gap:6px;align-items:end">
  <button onclick="mostrarEmparejar()" style="padding:8px 12px;background:#ff9800;color:#fff;border:none;border-radius:5px;cursor:pointer">Vincular ID</button>
  <div id="emparejarContainer" class="hidden" style="gap:6px">
    <input id="emparejarId" placeholder="ID pareja‚Ä¶" maxlength="8" style="padding:8px;border:1px solid #ccc;border-radius:5px;font-size:14px">
    <button onclick="vincular()" style="padding:8px 12px;background:#f57c00;color:#fff;border:none;border-radius:5px;cursor:pointer">Vincular</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let idDispositivo="",centrado=false,miLat=0,miLng=0;
let markerYo=null,markerPareja=null,markerOtro=null;
let map;

// ---------- Registro ----------
async function registrar(){
  const id=document.getElementById('inputId').value.trim();
  const nombre=document.getElementById('inputNombre').value.trim();
  const correo=document.getElementById('inputCorreo').value.trim();
  const telefono=document.getElementById('inputTelefono').value.trim();
  if(id.length!==8||!nombre||!correo||!telefono){alert("Completa todos los campos correctamente.");return;}
  const r=await fetch("/registrar",{method:"POST",headers:{"Content-Type":"application/json"},
             body:JSON.stringify({id,nombre,correo,telefono})});
  const res=await r.json();
  res.status==="ok"? (alert("¬°Registrado! Ingresa con tu ID."),location.hash="#login")
                   : alert("Error: "+res.error);
}

// ---------- Login ----------
function iniciarSesion(){
  const id=document.getElementById('inputIdLogin').value.trim();
  if(id.length!==8){alert("El ID debe tener 8 d√≠gitos.");return;}
  fetch(`/validar_id/${id}`).then(r=>r.json()).then(res=>{
    if(res.valido){
      idDispositivo=id;
      document.getElementById("map").classList.remove("hidden");
      document.getElementById("searchBox").classList.remove("hidden");
      document.getElementById("linkBox").classList.remove("hidden");  // üëà NUEVO
      location.hash="";
      iniciarMapa();
    }else alert("ID no registrado.");
  });
}

// ---------- Enviar ubicaci√≥n ----------
function enviarUbicacion(){
  if(!navigator.geolocation){alert("Geolocalizaci√≥n no soportada.");return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    fetch("/ubicacion",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({id:idDispositivo,lat:pos.coords.latitude,lng:pos.coords.longitude})});
  });
}

// ---------- Iniciar mapa ----------
function iniciarMapa(){
  map=L.map('map').setView([0,0],2); window._mapReferencia=map;
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              {attribution:'¬© OpenStreetMap'}).addTo(map);

  function actualizar(){
    fetch(`/ubicacion/${idDispositivo}`).then(r=>r.json()).then(data=>{
      if(data.yo&&data.yo.lat&&data.yo.lng){
        if(markerYo)map.removeLayer(markerYo);
        markerYo=L.marker([data.yo.lat,data.yo.lng],
          {icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',iconSize:[32,32]})})
          .addTo(map).bindPopup("T√∫");
        miLat=data.yo.lat;miLng=data.yo.lng;
        if(!centrado){map.setView([miLat,miLng],16);centrado=true;}
        document.getElementById("centrarBtn").style.display="block";
      }
      if(data.pareja&&data.pareja.lat&&data.pareja.lng){
        if(markerPareja)map.removeLayer(markerPareja);
        markerPareja=L.marker([data.pareja.lat,data.pareja.lng],
          {icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',iconSize:[32,32]})})
          .addTo(map).bindPopup("Tu pareja");
      }
    });
  }

  setInterval(()=>{enviarUbicacion();actualizar();},5000);
}

// ---------- Bot√≥n centrar ----------
function centrarEnMiUbicacion(){
  if(miLat&&miLng)map.setView([miLat,miLng],16);
}

// ---------- Buscar otro ID ----------
function buscarOtro(){
  const otroId=document.getElementById("searchId").value.trim();
  if(otroId.length!==8){alert("ID inv√°lido.");return;}
  fetch(`/ubicacion/${otroId}`).then(r=>r.json()).then(data=>{
    if(data.yo&&data.yo.lat&&data.yo.lng){
      if(markerOtro)map.removeLayer(markerOtro);
      markerOtro=L.marker([data.yo.lat,data.yo.lng],
        {icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',iconSize:[32,32]})})
        .addTo(map).bindPopup("Dispositivo "+otroId).openPopup();
      map.setView([data.yo.lat,data.yo.lng],16);
    }else alert("Ese ID no env√≠a ubicaci√≥n a√∫n o no existe.");
  });
}


function mostrarEmparejar(){
  const cont = document.getElementById("emparejarContainer");
  const boton = document.querySelector("#linkBox button");
  const visible = !cont.classList.contains("hidden");

  if(visible){
    cont.classList.add("hidden");
    cont.style.display = "none";
    boton.textContent = "Vincular ID";
  }else{
    cont.classList.remove("hidden");
    cont.style.display = "flex";
    boton.textContent = "Ocultar";
  }
}

// Emparejar con otro ID
function vincular(){
  const parejaId = document.getElementById("emparejarId").value.trim();
  if(parejaId.length !== 8){
    alert("El ID debe tener 8 d√≠gitos.");
    return;
  }
  if(parejaId === idDispositivo){
    alert("No puedes emparejarte contigo mismo.");
    return;
  }

  fetch("/vincular", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({mi_id: idDispositivo, pareja_id: parejaId})
  })
  .then(r => r.json())
  .then(res => {
    if(res.status === "vinculado"){
      alert("¬°Pareja vinculada con √©xito!");
      document.getElementById("emparejarId").value = "";
      document.getElementById("emparejarContainer").classList.add("hidden");
    }else{
      alert("Error: " + res.error);
    }
  });
}

window.onload=()=>{if(!location.hash)location.hash="#login";}
</script>
</body>
</html>